{"version":3,"sources":["../../src/auth/auth.adapter.ts"],"sourcesContent":["import { ConfigService } from '@nestjs/config'\nimport { NestExpressApplication } from '@nestjs/platform-express'\nimport { IoAdapter } from '@nestjs/platform-socket.io'\nimport { RedisStore } from 'connect-redis'\nimport session from 'express-session'\nimport sharedsession from 'express-socket.io-session'\nimport { RedisClientType } from 'redis'\nimport { Server } from 'socket.io'\n\n/**\n * Enable session tokens for web sockets by using express-socket.io-session\n */\nexport class EventsAdapter extends IoAdapter {\n  private app: NestExpressApplication\n  private redisClient: RedisClientType\n\n  constructor(app: NestExpressApplication, redisClient: RedisClientType) {\n    super(app)\n    this.app = app\n    this.redisClient = redisClient\n  }\n\n  createIOServer(port: number, options?: any): any {\n    const server: Server = super.createIOServer(port, options)\n    const configService: ConfigService = this.app.get(ConfigService)\n\n    const _session = session({\n      store: new RedisStore({ client: this.redisClient, prefix: 'session:' }),\n      secret: process.env.SESSION_SECRET || 'keyboard cat',\n      resave: false,\n      saveUninitialized: true,\n      cookie: {\n        httpOnly: true,\n        secure: false, // true in production with HTTPS\n        maxAge: 1000 * 60 * 60 * 24, // 1 day\n      },\n    })\n\n    this.app.use(_session)\n    server.use(\n      // @ts-ignore\n      sharedsession(_session, {\n        autoSave: true,\n      }),\n    )\n    return server\n  }\n}\n"],"names":["EventsAdapter","IoAdapter","createIOServer","port","options","server","configService","app","get","ConfigService","_session","session","store","RedisStore","client","redisClient","prefix","secret","process","env","SESSION_SECRET","resave","saveUninitialized","cookie","httpOnly","secure","maxAge","use","sharedsession","autoSave"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZiB;kCAEJ;8BACC;uEACP;+EACM;;;;;;AAOnB,IAAA,AAAMA,gBAAN,MAAMA,sBAAsBC,2BAAS;IAU1CC,eAAeC,IAAY,EAAEC,OAAa,EAAO;QAC/C,MAAMC,SAAiB,KAAK,CAACH,eAAeC,MAAMC;QAClD,MAAME,gBAA+B,IAAI,CAACC,GAAG,CAACC,GAAG,CAACC,qBAAa;QAE/D,MAAMC,WAAWC,IAAAA,uBAAO,EAAC;YACvBC,OAAO,IAAIC,wBAAU,CAAC;gBAAEC,QAAQ,IAAI,CAACC,WAAW;gBAAEC,QAAQ;YAAW;YACrEC,QAAQC,QAAQC,GAAG,CAACC,cAAc,IAAI;YACtCC,QAAQ;YACRC,mBAAmB;YACnBC,QAAQ;gBACNC,UAAU;gBACVC,QAAQ;gBACRC,QAAQ,OAAO,KAAK,KAAK;YAC3B;QACF;QAEA,IAAI,CAACnB,GAAG,CAACoB,GAAG,CAACjB;QACbL,OAAOsB,GAAG,CACR,aAAa;QACbC,IAAAA,+BAAa,EAAClB,UAAU;YACtBmB,UAAU;QACZ;QAEF,OAAOxB;IACT;IA9BA,YAAYE,GAA2B,EAAEQ,WAA4B,CAAE;QACrE,KAAK,CAACR;QACN,IAAI,CAACA,GAAG,GAAGA;QACX,IAAI,CAACQ,WAAW,GAAGA;IACrB;AA2BF"}